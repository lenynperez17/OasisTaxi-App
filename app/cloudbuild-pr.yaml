# ðŸ” CLOUD BUILD CONFIGURATION - PULL REQUESTS
# ConfiguraciÃ³n especÃ­fica para PRs de OasisTaxi
# Ejecuta validaciones sin deployment
# VersiÃ³n: PR Validation 1.0

steps:
  # ============================================
  # STEP 1: SETUP BÃSICO
  # ============================================
  - name: 'gcr.io/cloud-builders/git'
    id: 'clone-and-setup'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ”„ Configurando entorno para PR..."
        echo "ðŸ“‹ PR Number: ${_PR_NUMBER}"
        echo "ðŸŒ¿ Source Branch: ${_HEAD_BRANCH}"
        echo "ðŸŽ¯ Target Branch: ${_BASE_BRANCH}"

  # ============================================
  # STEP 2: FLUTTER SETUP
  # ============================================
  - name: 'cirrusci/flutter:stable'
    id: 'flutter-setup'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸš€ Configurando Flutter para PR validation..."
        cd app
        flutter doctor -v
        flutter pub get

  # ============================================
  # STEP 3: ANÃLISIS DE CÃ“DIGO
  # ============================================
  - name: 'cirrusci/flutter:stable'
    id: 'code-analysis'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ” AnÃ¡lisis de cÃ³digo..."
        cd app
        # PR VALIDATION: Fail on warnings (--fatal-warnings)
        flutter analyze --no-pub --fatal-warnings > analysis_report.txt 2>&1
        ANALYZE_EXIT_CODE=$?

        # Mostrar resultados
        cat analysis_report.txt

        # Verificar resultado
        if [ $ANALYZE_EXIT_CODE -ne 0 ]; then
          echo "âŒ Se encontraron errores o warnings en el anÃ¡lisis"
          echo "Los PRs deben pasar sin warnings para mantener la calidad del cÃ³digo"
          exit 1
        else
          echo "âœ… AnÃ¡lisis de cÃ³digo completado sin errores ni warnings"
        fi

  # ============================================
  # STEP 4: TESTS UNITARIOS
  # ============================================
  - name: 'cirrusci/flutter:stable'
    id: 'unit-tests'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ§ª Ejecutando tests unitarios..."
        cd app
        flutter test --coverage --reporter json > test_results.json 2>&1
        flutter test --coverage
        
        if [ $? -eq 0 ]; then
          echo "âœ… Todos los tests unitarios pasaron"
          
          # Calcular cobertura
          if [ -f "coverage/lcov.info" ]; then
            echo "ðŸ“Š Generando reporte de cobertura..."
            # AquÃ­ podrÃ­as agregar herramientas para calcular % de cobertura
          fi
        else
          echo "âŒ Algunos tests unitarios fallaron"
          exit 1
        fi

  # ============================================
  # STEP 5: FORMATTING CHECK
  # ============================================
  - name: 'cirrusci/flutter:stable'
    id: 'format-check'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ“ Verificando formato del cÃ³digo..."
        cd app
        flutter format --dry-run --set-exit-if-changed lib/
        
        if [ $? -eq 0 ]; then
          echo "âœ… Formato del cÃ³digo es correcto"
        else
          echo "âŒ CÃ³digo no estÃ¡ formateado correctamente"
          echo "ðŸ’¡ Ejecuta: flutter format lib/"
          exit 1
        fi

  # ============================================
  # STEP 6: BUILD VERIFICATION (SIN RELEASE)
  # ============================================
  - name: 'cirrusci/flutter:stable'
    id: 'build-verification'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ”¨ Verificando que el proyecto compila..."
        cd app
        
        # Build debug para verificar compilaciÃ³n
        flutter build apk --debug --dart-define=ENVIRONMENT=development
        
        if [ $? -eq 0 ]; then
          echo "âœ… Proyecto compila correctamente"
        else
          echo "âŒ Error en la compilaciÃ³n"
          exit 1
        fi

  # ============================================
  # STEP 7: DEPENDENCY CHECK
  # ============================================
  - name: 'cirrusci/flutter:stable'
    id: 'dependency-check'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ“¦ Verificando dependencias..."
        cd app
        
        # Verificar dependencias obsoletas
        flutter pub deps --json > deps.json
        flutter pub outdated --json > outdated.json 2>/dev/null || true
        
        echo "âœ… VerificaciÃ³n de dependencias completada"

  # ============================================
  # STEP 8: SECURITY SCAN (BÃSICO)
  # ============================================
  - name: 'cirrusci/flutter:stable'
    id: 'security-scan'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ”’ Escaneo bÃ¡sico de seguridad..."
        cd app
        
        # Buscar hardcoded secrets (bÃ¡sico)
        echo "Verificando secrets hardcodeados..."
        if grep -r "password\s*=\s*['\"][^'\"]*['\"]" lib/ --exclude-dir=test || \
           grep -r "api_key\s*=\s*['\"][^'\"]*['\"]" lib/ --exclude-dir=test || \
           grep -r "secret\s*=\s*['\"][^'\"]*['\"]" lib/ --exclude-dir=test; then
          echo "âš ï¸ Posibles secrets hardcodeados encontrados"
          echo "ðŸ’¡ Por favor revisa y usa variables de entorno"
        else
          echo "âœ… No se encontraron secrets hardcodeados obvios"
        fi

  # ============================================
  # STEP 9: GENERAR REPORTE DE PR
  # ============================================
  - name: 'gcr.io/cloud-builders/curl'
    id: 'generate-report'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ðŸ“„ Generando reporte de PR..."
        
        # Crear reporte
        cat > pr_report.md << EOF
        # ðŸ“‹ Reporte de PR #${_PR_NUMBER}
        
        ## âœ… Validaciones Completadas
        
        - âœ… **AnÃ¡lisis de cÃ³digo**: Sin errores crÃ­ticos
        - âœ… **Tests unitarios**: Todos los tests pasaron
        - âœ… **Formato**: CÃ³digo correctamente formateado
        - âœ… **CompilaciÃ³n**: Proyecto compila sin errores
        - âœ… **Dependencias**: Verificadas
        - âœ… **Seguridad**: Escaneo bÃ¡sico completado
        
        ## ðŸ“Š EstadÃ­sticas
        
        - **Branch origen**: ${_HEAD_BRANCH}
        - **Branch destino**: ${_BASE_BRANCH}
        - **Commit**: ${SHORT_SHA}
        - **Fecha**: $(date)
        - **DuraciÃ³n build**: Completado
        
        ## ðŸš€ Estado
        
        âœ… **PR listo para revisiÃ³n**
        
        Todas las validaciones automÃ¡ticas han pasado exitosamente.
        El cÃ³digo estÃ¡ listo para revisiÃ³n manual por el equipo.
        EOF
        
        echo "Reporte generado:"
        cat pr_report.md

# ============================================
# CONFIGURACIÃ“N ESPECÃFICA PARA PRs
# ============================================
options:
  # MÃ¡quina mÃ¡s pequeÃ±a para PRs (mÃ¡s econÃ³mico)
  machineType: 'E2_STANDARD_2'
  
  # Timeout menor para PRs (15 minutos)
  timeout: '900s'
  
  # Disk size menor
  diskSizeGb: 50
  
  # Logging
  logging: GCS_ONLY
  logsBucket: 'gs://${_LOGS_BUCKET}'

# ============================================
# VARIABLES ESPECÃFICAS PARA PRs
# ============================================
substitutions:
  # InformaciÃ³n del PR
  _PR_NUMBER: ''
  _HEAD_BRANCH: ''
  _BASE_BRANCH: 'main'
  
  # Buckets (mismos que producciÃ³n)
  _LOGS_BUCKET: 'oasis-taxi-build-logs'
  
  # ConfiguraciÃ³n
  _ENVIRONMENT: 'development'

# ============================================
# TAGS PARA PRs
# ============================================
tags:
  - 'oasistaxi'
  - 'flutter'
  - 'pr-validation'
  - 'development'

# ============================================
# ARTIFACTS PARA PRs (MÃNIMOS)
# ============================================
artifacts:
  objects:
    location: 'gs://${_LOGS_BUCKET}/pr-artifacts'
    paths:
      - 'app/analysis_report.txt'
      - 'app/test_results.json'
      - 'app/coverage/lcov.info'
      - 'pr_report.md'