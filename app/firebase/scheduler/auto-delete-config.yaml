# ğŸ—‚ï¸ CONFIGURACIÃ“N DE CLOUD SCHEDULER PARA AUTO-DELETE
# OasisTaxi PerÃº - Sistema de EliminaciÃ³n AutomÃ¡tica de Archivos de Chat
# 
# Este archivo define los trabajos de Cloud Scheduler para:
# - EliminaciÃ³n automÃ¡tica de archivos expirados cada hora
# - Limpieza de estadÃ­sticas antiguas diariamente
# - Reporte semanal de uso de almacenamiento

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ• JOB 1: ELIMINACIÃ“N AUTOMÃTICA CADA HORA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: "auto-delete-chat-files-hourly"
description: "EliminaciÃ³n automÃ¡tica de archivos de chat expirados - OasisTaxi"
schedule: "0 * * * *" # Cada hora en punto
time_zone: "America/Lima" # Zona horaria de PerÃº
target:
  pubsub_target:
    topic_name: "projects/oasis-taxi-peru/topics/auto-delete-chat-files"
    data: |
      {
        "source": "scheduler",
        "job": "auto-delete-chat-files-hourly",
        "executedAt": "2024-01-01T00:00:00Z"
      }
retry_config:
  retry_count: 3
  max_retry_duration: "600s"
  min_backoff_duration: "5s"
  max_backoff_duration: "3600s"

---

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ§¹ JOB 2: LIMPIEZA DE ESTADÃSTICAS ANTIGUAS DIARIA
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: "cleanup-auto-delete-stats-daily"
description: "Limpieza diaria de estadÃ­sticas de auto-delete antiguas - OasisTaxi"
schedule: "0 2 * * *" # Todos los dÃ­as a las 2:00 AM
time_zone: "America/Lima"
target:
  pubsub_target:
    topic_name: "projects/oasis-taxi-peru/topics/cleanup-old-stats"
    data: |
      {
        "source": "scheduler",
        "job": "cleanup-auto-delete-stats-daily",
        "action": "cleanup_old_stats",
        "retentionDays": 30,
        "executedAt": "2024-01-01T02:00:00Z"
      }
retry_config:
  retry_count: 2
  max_retry_duration: "300s"

---

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“Š JOB 3: REPORTE SEMANAL DE ALMACENAMIENTO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: "weekly-storage-report"
description: "Reporte semanal de uso de almacenamiento por usuario - OasisTaxi"
schedule: "0 8 * * 1" # Lunes a las 8:00 AM
time_zone: "America/Lima"
target:
  pubsub_target:
    topic_name: "projects/oasis-taxi-peru/topics/generate-storage-report"
    data: |
      {
        "source": "scheduler",
        "job": "weekly-storage-report",
        "reportType": "storage_usage",
        "includeSummary": true,
        "includeTopUsers": true,
        "executedAt": "2024-01-01T08:00:00Z"
      }
retry_config:
  retry_count: 1
  max_retry_duration: "120s"

---

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš¨ JOB 4: ELIMINACIÃ“N DE ARCHIVOS CRÃTICOS (URGENTE)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: "critical-auto-delete-every-15min"
description: "EliminaciÃ³n crÃ­tica cada 15 minutos para archivos marcados como urgentes - OasisTaxi"
schedule: "*/15 * * * *" # Cada 15 minutos
time_zone: "America/Lima"
target:
  pubsub_target:
    topic_name: "projects/oasis-taxi-peru/topics/auto-delete-chat-files"
    data: |
      {
        "source": "scheduler",
        "job": "critical-auto-delete-every-15min",
        "priority": "critical",
        "onlyUrgent": true,
        "maxFiles": 50,
        "executedAt": "2024-01-01T00:00:00Z"
      }
retry_config:
  retry_count: 5
  max_retry_duration: "900s"
  min_backoff_duration: "10s"
  max_backoff_duration: "300s"

---

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”§ COMANDOS PARA CREAR LOS JOBS EN GOOGLE CLOUD
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# 1. ELIMINACIÃ“N AUTOMÃTICA CADA HORA
gcloud scheduler jobs create pubsub auto-delete-chat-files-hourly \
  --location=us-central1 \
  --schedule="0 * * * *" \
  --time-zone="America/Lima" \
  --topic="auto-delete-chat-files" \
  --message-body='{"source":"scheduler","job":"auto-delete-chat-files-hourly"}' \
  --description="EliminaciÃ³n automÃ¡tica de archivos de chat expirados - OasisTaxi" \
  --max-retry-attempts=3 \
  --max-retry-duration=600s \
  --min-backoff-duration=5s \
  --max-backoff-duration=3600s

# 2. LIMPIEZA DE ESTADÃSTICAS DIARIA
gcloud scheduler jobs create pubsub cleanup-auto-delete-stats-daily \
  --location=us-central1 \
  --schedule="0 2 * * *" \
  --time-zone="America/Lima" \
  --topic="cleanup-old-stats" \
  --message-body='{"source":"scheduler","job":"cleanup-auto-delete-stats-daily","action":"cleanup_old_stats","retentionDays":30}' \
  --description="Limpieza diaria de estadÃ­sticas de auto-delete antiguas - OasisTaxi" \
  --max-retry-attempts=2 \
  --max-retry-duration=300s

# 3. REPORTE SEMANAL DE ALMACENAMIENTO
gcloud scheduler jobs create pubsub weekly-storage-report \
  --location=us-central1 \
  --schedule="0 8 * * 1" \
  --time-zone="America/Lima" \
  --topic="generate-storage-report" \
  --message-body='{"source":"scheduler","job":"weekly-storage-report","reportType":"storage_usage","includeSummary":true,"includeTopUsers":true}' \
  --description="Reporte semanal de uso de almacenamiento por usuario - OasisTaxi" \
  --max-retry-attempts=1 \
  --max-retry-duration=120s

# 4. ELIMINACIÃ“N CRÃTICA CADA 15 MINUTOS
gcloud scheduler jobs create pubsub critical-auto-delete-every-15min \
  --location=us-central1 \
  --schedule="*/15 * * * *" \
  --time-zone="America/Lima" \
  --topic="auto-delete-chat-files" \
  --message-body='{"source":"scheduler","job":"critical-auto-delete-every-15min","priority":"critical","onlyUrgent":true,"maxFiles":50}' \
  --description="EliminaciÃ³n crÃ­tica cada 15 minutos para archivos marcados como urgentes - OasisTaxi" \
  --max-retry-attempts=5 \
  --max-retry-duration=900s \
  --min-backoff-duration=10s \
  --max-backoff-duration=300s

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“‹ VERIFICACIÃ“N DE JOBS CREADOS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Listar todos los jobs de Cloud Scheduler
gcloud scheduler jobs list --location=us-central1

# Ver detalles de un job especÃ­fico
gcloud scheduler jobs describe auto-delete-chat-files-hourly --location=us-central1

# Ejecutar un job manualmente (para pruebas)
gcloud scheduler jobs run auto-delete-chat-files-hourly --location=us-central1

# Ver logs de ejecuciÃ³n
gcloud logging read "resource.type=cloud_scheduler_job AND resource.labels.job_id=auto-delete-chat-files-hourly" --limit=10 --format=json

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”„ TÃ“PICOS PUBSUB NECESARIOS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Crear tÃ³picos Pub/Sub si no existen
gcloud pubsub topics create auto-delete-chat-files
gcloud pubsub topics create cleanup-old-stats
gcloud pubsub topics create generate-storage-report

# Verificar tÃ³picos creados
gcloud pubsub topics list

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ›¡ï¸ PERMISOS NECESARIOS PARA CLOUD SCHEDULER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# El servicio de Cloud Scheduler necesita permisos para:
# 1. Publicar en tÃ³picos Pub/Sub
# 2. Invocar Cloud Functions
# 3. Acceder a Cloud Storage
# 4. Escribir logs

# Configurar permisos automÃ¡ticamente:
gcloud projects add-iam-policy-binding oasis-taxi-peru \
  --member="serviceAccount:service-PROJECT_NUMBER@gcp-sa-cloudscheduler.iam.gserviceaccount.com" \
  --role="roles/pubsub.publisher"

gcloud projects add-iam-policy-binding oasis-taxi-peru \
  --member="serviceAccount:service-PROJECT_NUMBER@gcp-sa-cloudscheduler.iam.gserviceaccount.com" \
  --role="roles/cloudfunctions.invoker"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“Š MONITOREO Y ALERTAS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Crear alertas para fallos en jobs crÃ­ticos
# 1. Alert si auto-delete falla 3 veces seguidas
# 2. Alert si el almacenamiento excede lÃ­mites
# 3. Alert si hay demasiados archivos pendientes de eliminaciÃ³n

# Script para crear alertas (requiere configuraciÃ³n adicional):
# gcloud alpha monitoring policies create --policy-from-file=alerts/auto-delete-alerts.yaml

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ NOTAS IMPORTANTES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# 1. TIEMPO DE RETENCIÃ“N:
#    - Archivos de chat: 90 dÃ­as por defecto
#    - EstadÃ­sticas: 30 dÃ­as
#    - Logs de auditorÃ­a: 365 dÃ­as
#    - Archivos crÃ­ticos: 7 dÃ­as mÃ¡ximo

# 2. LÃMITES DE CUOTA:
#    - 1 GB por usuario mÃ¡ximo
#    - 100 archivos por chat mÃ¡ximo
#    - 50 MB por archivo mÃ¡ximo

# 3. HORARIOS OPTIMIZADOS:
#    - EliminaciÃ³n principal: cada hora
#    - Limpieza de stats: 2:00 AM (poco trÃ¡fico)
#    - Reportes: lunes 8:00 AM (inicio de semana)
#    - CrÃ­ticos: cada 15 min (respuesta rÃ¡pida)

# 4. ZONAS HORARIAS:
#    - Configurado para America/Lima (PerÃº)
#    - UTC-5 en horario estÃ¡ndar
#    - UTC-5 durante todo el aÃ±o (no hay cambio de horario)

# 5. RECUPERACIÃ“N ANTE FALLOS:
#    - Reintentos automÃ¡ticos configurados
#    - Backoff exponencial para evitar spam
#    - Alertas automÃ¡ticas en fallos crÃ­ticos
#    - Logs detallados para debugging