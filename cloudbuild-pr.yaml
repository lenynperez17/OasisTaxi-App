# ðŸš– OASIS TAXI PERÃš - Cloud Build para Pull Requests
# Pipeline ligero para validaciÃ³n de PRs: anÃ¡lisis, tests y build bÃ¡sico

substitutions:
  _PROJECT_ID: 'oasis-taxi-peru-prod'
  _FLUTTER_VERSION: '3.24.4'
  _JAVA_VERSION: '11'

timeout: '1800s' # 30 minutos para PRs
options:
  machineType: 'E2_HIGHCPU_4'
  diskSizeGb: 50

steps:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ“‹ FASE 1: SETUP RÃPIDO PARA PR
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: 'setup-flutter-pr'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    echo "ðŸ”„ Setup Flutter para validaciÃ³n de PR..."
    
    # Instalar dependencias bÃ¡sicas
    apt-get update && apt-get install -y curl unzip openjdk-${_JAVA_VERSION}-jdk
    
    # Configurar Java
    export JAVA_HOME=/usr/lib/jvm/java-${_JAVA_VERSION}-openjdk-amd64
    
    # Instalar Flutter
    cd /tmp
    curl -O https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_${_FLUTTER_VERSION}-stable.tar.xz
    tar xf flutter_linux_${_FLUTTER_VERSION}-stable.tar.xz
    export PATH="/tmp/flutter/bin:${PATH}"
    
    # Configurar entorno
    echo "JAVA_HOME=${JAVA_HOME}" > /workspace/env.txt
    echo "PATH=/tmp/flutter/bin:${PATH}" >> /workspace/env.txt
    
    flutter --version
    echo "âœ… Flutter configurado para PR"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ“‹ FASE 2: ANÃLISIS ESTÃTICO
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: 'analyze-pr'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    source /workspace/env.txt
    cd /workspace/oasistaxi/app
    
    echo "ðŸ” Analizando cÃ³digo del PR..."
    
    # Obtener dependencias
    flutter pub get
    
    # AnÃ¡lisis estÃ¡tico
    flutter analyze --no-pub --fatal-infos
    
    # Verificar formato
    dart format --output=none --set-exit-if-changed .
    
    # Verificar que no hay TODOs/FIXMEs crÃ­ticos
    echo "ðŸ”Ž Verificando TODOs crÃ­ticos..."
    if grep -r "TODO.*CRITICAL\|FIXME.*URGENT" lib/; then
      echo "âŒ Se encontraron TODOs/FIXMEs crÃ­ticos que deben resolverse"
      exit 1
    fi
    
    echo "âœ… AnÃ¡lisis de cÃ³digo aprobado"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ“‹ FASE 3: TESTS UNITARIOS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: 'test-pr'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    source /workspace/env.txt
    cd /workspace/oasistaxi/app
    
    echo "ðŸ§ª Ejecutando tests del PR..."
    
    # Tests unitarios rÃ¡pidos
    flutter test --reporter=json > test_results.json
    
    # Verificar que no fallan tests
    if [ $? -ne 0 ]; then
      echo "âŒ Tests fallando en el PR"
      exit 1
    fi
    
    echo "âœ… Todos los tests pasan"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ“‹ FASE 4: BUILD BÃSICO DE VALIDACIÃ“N
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: 'build-validation'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    source /workspace/env.txt
    cd /workspace/oasistaxi/app
    
    echo "ðŸ”¨ Build de validaciÃ³n para PR..."
    
    # Build debug para validar que compila
    flutter build apk --debug --target lib/main.dart
    
    # Build web para validar
    flutter build web --debug --target lib/main.dart
    
    echo "âœ… Build de validaciÃ³n exitoso"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ðŸ“‹ FASE 5: REPORTE DE PR
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: 'pr-report'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    echo "ðŸ“Š Generando reporte de PR..."
    
    # Crear reporte de validaciÃ³n
    cat > pr-report.md << EOF
    # ðŸš– OasisTaxi PR Validation Report
    
    ## âœ… Validaciones Completadas
    - [x] AnÃ¡lisis estÃ¡tico de cÃ³digo
    - [x] Formato de cÃ³digo correcto  
    - [x] Tests unitarios pasan
    - [x] Build de validaciÃ³n exitoso
    - [x] No hay TODOs/FIXMEs crÃ­ticos
    
    ## ðŸ“Š EstadÃ­sticas
    - Build ID: ${BUILD_ID}
    - Branch: ${BRANCH_NAME}
    - Commit: ${SHORT_SHA}
    
    ## ðŸš€ Estado: APROBADO âœ…
    
    El PR estÃ¡ listo para revisiÃ³n manual.
    EOF
    
    echo "âœ… Reporte de PR generado"
    cat pr-report.md