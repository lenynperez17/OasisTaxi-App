# ğŸš– OASIS TAXI PERÃš - GitHub Actions CI/CD
# Pipeline completo para builds, tests y deployment usando GitHub Actions

name: OasisTaxi CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Builds nocturnos a las 2 AM UTC (11 PM Lima)
    - cron: '0 2 * * *'

env:
  FLUTTER_VERSION: '3.24.4'
  JAVA_VERSION: '11'
  NODE_VERSION: '18'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“‹ JOB 1: ANÃLISIS Y VALIDACIÃ“N
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  analyze:
    name: ğŸ” AnÃ¡lisis de CÃ³digo
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        distribution: 'adopt'
        java-version: ${{ env.JAVA_VERSION }}

    - name: ğŸ“± Setup Flutter ${{ env.FLUTTER_VERSION }}
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Obtener dependencias
      working-directory: app
      run: |
        flutter pub get
        flutter pub deps

    - name: ğŸ” AnÃ¡lisis estÃ¡tico
      working-directory: app
      run: |
        echo "ğŸ” Ejecutando anÃ¡lisis estÃ¡tico de OasisTaxi..."
        flutter analyze --no-pub --fatal-infos
        
        echo "ğŸ“ Verificando formato de cÃ³digo..."
        dart format --output=none --set-exit-if-changed .
        
        echo "ğŸ” Verificando TODOs crÃ­ticos..."
        if grep -r "TODO.*CRITICAL\|FIXME.*URGENT" lib/; then
          echo "âŒ Se encontraron TODOs/FIXMEs crÃ­ticos"
          exit 1
        fi

    - name: ğŸ“Š Subir resultados de anÃ¡lisis
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: analysis-results
        path: app/analysis_options.yaml

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“‹ JOB 2: TESTING COMPLETO
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: ğŸ§ª Testing
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: analyze
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        distribution: 'adopt'
        java-version: ${{ env.JAVA_VERSION }}

    - name: ğŸ“± Setup Flutter ${{ env.FLUTTER_VERSION }}
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Obtener dependencias
      working-directory: app
      run: flutter pub get

    - name: ğŸ§ª Tests unitarios
      working-directory: app
      run: |
        echo "ğŸ§ª Ejecutando tests de OasisTaxi..."
        flutter test --coverage --reporter=json > test_results.json
        
        echo "ğŸ“Š Generando reporte de cobertura..."
        genhtml coverage/lcov.info -o coverage/html || true

    - name: ğŸ“ˆ Verificar cobertura
      working-directory: app
      run: |
        if [ -f coverage/lcov.info ]; then
          COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | awk '{print $2}' | sed 's/%//' || echo "0")
          echo "ğŸ“Š Cobertura de tests: $COVERAGE%"
          
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "âš ï¸ Cobertura baja: $COVERAGE%. Recomendado: >70%"
          else
            echo "âœ… Cobertura aceptable: $COVERAGE%"
          fi
        fi

    - name: ğŸ“Š Subir resultados de tests
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          app/test_results.json
          app/coverage/
        retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“‹ JOB 3: BUILD ANDROID
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-android:
    name: ğŸ¤– Build Android
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [analyze, test]
    if: github.event_name != 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        distribution: 'adopt'
        java-version: ${{ env.JAVA_VERSION }}

    - name: ğŸ“± Setup Flutter ${{ env.FLUTTER_VERSION }}
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ğŸ” Configurar secretos Android
      working-directory: app
      env:
        KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        KEY_PROPERTIES: ${{ secrets.ANDROID_KEY_PROPERTIES }}
        GOOGLE_SERVICES: ${{ secrets.GOOGLE_SERVICES_ANDROID }}
      run: |
        if [ ! -z "$KEYSTORE_BASE64" ]; then
          echo "ğŸ”‘ Configurando keystore Android..."
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/keystore.jks
          echo "$KEY_PROPERTIES" > android/key.properties
        fi
        
        if [ ! -z "$GOOGLE_SERVICES" ]; then
          echo "ğŸ”§ Configurando Google Services..."
          echo "$GOOGLE_SERVICES" > android/app/google-services.json
        fi

    - name: ğŸ“¦ Obtener dependencias
      working-directory: app
      run: flutter pub get

    - name: ğŸ¤– Build Android APK
      working-directory: app
      run: |
        echo "ğŸ¤– Building Android APK para OasisTaxi..."
        flutter build apk --release \
          --target lib/main.dart \
          --split-per-abi \
          --obfuscate \
          --split-debug-info=build/app/outputs/symbols

    - name: ğŸ“¦ Build Android App Bundle
      working-directory: app
      run: |
        echo "ğŸ“¦ Building Android App Bundle..."
        flutter build appbundle --release \
          --target lib/main.dart \
          --obfuscate \
          --split-debug-info=build/app/outputs/symbols

    - name: ğŸ“Š Subir APKs
      uses: actions/upload-artifact@v4
      with:
        name: android-apks
        path: |
          app/build/app/outputs/flutter-apk/*.apk
          app/build/app/outputs/bundle/release/*.aab
        retention-days: 90

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“‹ JOB 4: BUILD WEB
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-web:
    name: ğŸŒ Build Web
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [analyze, test]
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ“± Setup Flutter ${{ env.FLUTTER_VERSION }}
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: ğŸ“¦ Obtener dependencias
      working-directory: app
      run: flutter pub get

    - name: ğŸŒ Build Web
      working-directory: app
      run: |
        echo "ğŸŒ Building Web App para OasisTaxi..."
        flutter build web --release \
          --target lib/main.dart \
          --web-renderer html \
          --base-href "/"

    - name: ğŸ“Š Subir build web
      uses: actions/upload-artifact@v4
      with:
        name: web-build
        path: app/build/web/
        retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“‹ JOB 5: DEPLOYMENT (Solo en main)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-android, build-web]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: app/functions/package-lock.json

    - name: ğŸ“¥ Descargar web build
      uses: actions/download-artifact@v4
      with:
        name: web-build
        path: app/build/web/

    - name: ğŸ” Configurar Firebase
      working-directory: app
      env:
        FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      run: |
        echo "$FIREBASE_SERVICE_ACCOUNT" > firebase-key.json
        export GOOGLE_APPLICATION_CREDENTIALS=firebase-key.json

    - name: ğŸš€ Deploy a Firebase
      working-directory: app
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        npm install -g firebase-tools
        
        echo "ğŸš€ Deploying OasisTaxi a Firebase..."
        firebase deploy --only hosting,firestore,storage --token "$FIREBASE_TOKEN"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“‹ JOB 6: NOTIFICACIONES
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify:
    name: ğŸ“¢ Notificar
    runs-on: ubuntu-latest
    needs: [analyze, test, build-android, build-web, deploy]
    if: always()
    
    steps:
    - name: ğŸ“¢ NotificaciÃ³n Slack
      if: env.SLACK_WEBHOOK != ''
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      run: |
        STATUS="SUCCESS"
        if [[ "${{ needs.analyze.result }}" != "success" ]] || 
           [[ "${{ needs.test.result }}" != "success" ]] || 
           [[ "${{ needs.build-android.result }}" != "success" ]] || 
           [[ "${{ needs.build-web.result }}" != "success" ]]; then
          STATUS="FAILED"
        fi
        
        curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"ğŸš– OasisTaxi CI/CD: $STATUS - ${{ github.event.head_commit.message }}\"}" \
          "$SLACK_WEBHOOK"

    - name: ğŸ“§ NotificaciÃ³n por email
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: 'ğŸš– OasisTaxi CI/CD Failed'
        body: |
          El pipeline de CI/CD de OasisTaxi ha fallado.
          
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref }}
          Autor: ${{ github.actor }}
          
          Ver detalles: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        to: dev-team@oasistaxiperu.com
        from: ci-cd@oasistaxiperu.com